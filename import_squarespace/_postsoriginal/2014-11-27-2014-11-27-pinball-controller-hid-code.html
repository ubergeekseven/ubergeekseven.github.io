---
layout: post
title: Pinball Controller HID code
categories: []
tags: []
status: publish
type: post
published: true
meta: {}
---
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd">
<html><body><div class="sqs-html-content">
  <p>So, i worked on my controller for  a while last night. I have it working, but I need to refine the program a bit. </p>
<p>So far I have the left and right buttons, the trigger button and the shooter. The left and right buttons are digital. The shooter is a linear potentiometer, and the trigger button is digital but just sends the highest value from the potentiometer before the button was pressed.</p>
<p>The thing is, I can't quite figure out what I am doing wrong with the code. I know it has to clear the variable, but I began to get stuck in a loop last night, so I gave up until I could think clearly again.</p>
<p>This is the code currently, it is adapted from this project here:  http://www.imaginaryindustries.com/blog/?p=80 </p>
<p> </p>
<p>/*</p>
<p> </p>
<p>// this is the address of each button in the 4 bytes <br>definitions :<br>#define BUTTON_1 0x01<br>#define BUTTON_2 0x02<br>#define BUTTON_3 0x03<br>#define BUTTON_4 0x04<br>#define BUTTON_5 0x05<br>#define BUTTON_6 0x06<br>#define BUTTON_7 0x07<br>#define BUTTON_8 0x08<br>#define BUTTON_9 0x09<br>#define BUTTON_10 0x0A<br>#define BUTTON_11 0x0B<br>#define BUTTON_12 0x0C<br>#define BUTTON_13 0x0D<br>#define BUTTON_14 0x0E<br>#define BUTTON_15 0x0F<br>#define BUTTON_16 0x10<br>#define BUTTON_17 0x11<br>#define BUTTON_18 0x12<br>#define BUTTON_19 0x13<br>#define BUTTON_20 0x14<br>#define BUTTON_21 0x15<br>#define BUTTON_22 0x16<br>#define BUTTON_23 0x17<br>#define BUTTON_24 0x18<br>#define BUTTON_25 0x19<br>#define BUTTON_26 0x1A<br>#define BUTTON_27 0x1B<br>#define BUTTON_28 0x1C<br>#define BUTTON_29 0x1D<br>#define BUTTON_30 0x1E<br>#define BUTTON_31 0x1F<br>#define BUTTON_32 0x20</p>
<p>*/</p>
<p>#include &lt;Bounce2.h&gt;<br>JoyState_t joySt; // joystick HID descriptor</p>
<p><br>const bool DEBUG = false;  // set to true to debug the raw values<br>int BUTTON_1 = 11;// LEFT TRIGGER ON PINBALL<br>int BUTTON_2 = 10;//RIGHT TRIGGER ON PINBALL<br>int BUTTON_3 = 9; //Used to trigger the value of the pinball shooter at its apex<br>int throttlePin = A5; //One Axes for pinball shooter<br>int xPin = A2;<br>int yPin = A3;<br>int xZero, yZero;<br>int xValue, yValue;<br>int deadzone = 5;  // smaller values will be set to 0<br>int throttleValue;// CURRENTLY SET TO PINBALL LAUNCHER<br>unsigned int maxRead ; //SET MAXREAD AS THE MAX INPUT FOR THE BALL<br>unsigned int lastRead; // last stored reading greater than previous<br>unsigned int count;<br>unsigned int count1;<br>void setup()<br>{</p>
<p>//     if(DEBUG) {<br>         Serial.begin(57600);<br>     </p>
<p>        maxRead = 0;  //zero the value before loop<br>        lastRead = 0; // zero the value before loop<br>        count = 0;<br>        count1 = 0;<br>    // Setup the button with an internal pull-up :<br>  <br>  <br>        pinMode(BUTTON_1,INPUT_PULLUP); <br>        pinMode(BUTTON_2,INPUT_PULLUP);<br>        pinMode(throttlePin, INPUT);<br>        pinMode(xPin, INPUT);<br>        pinMode(yPin, INPUT);<br>        pinMode(BUTTON_3,INPUT_PULLUP);      <br>        xZero = analogRead(xPin);<br>    yZero = analogRead(yPin);<br>       <br>    </p>
<p>    // guessing that these values are zeroed at the beginning of the sketch<br>    joySt.xAxis = 0;<br>    joySt.yAxis = 0;<br>    joySt.zAxis = 0;<br>    joySt.xRotAxis = 0;<br>    joySt.yRotAxis = 0;<br>    joySt.zRotAxis = 0;<br>    joySt.throttle = 0;<br>    joySt.rudder = 0;<br>    joySt.hatSw1 = 0;<br>    joySt.hatSw2 = 0;<br>    joySt.buttons = 0;</p>
<p>}</p>
<p><br>void loop()<br>{<br>        joySt.buttons = 0x00; // off state<br>        <br>//        if (count = 1) {<br>        if (digitalRead(BUTTON_3) == HIGH){<br>        joySt.zAxis = 0;<br>//        count = 0;<br>        }<br>        </p>
<p>        <br>        if (digitalRead(BUTTON_1) == LOW){<br>        joySt.buttons += 0x01;<br>        <br>        }<br>        <br>        if (digitalRead(BUTTON_2) == LOW){<br>        joySt.buttons += 0x02; //adds the two inputs together<br>       <br>        }<br>        <br>        <br>        if (digitalRead(BUTTON_3) == LOW){<br>           joySt.zAxis = map(maxRead,0,1023,0,255);<br>//           count = 1;   <br>           <br>        }<br>        <br>        xValue = analogRead(xPin) - xZero;<br>    yValue = analogRead(yPin) - yZero;</p>
<p>    if(abs(xValue) &lt; deadzone) {<br>        xValue = 0;<br>    }<br>    if(abs(yValue) &lt; deadzone) {<br>        yValue = 0;<br>    }</p>
<p>     throttleValue = analogRead(throttlePin);  //(throttlePin) - throttleZero;<br>    <br>    <br>        // THIS SECTION WILL DETERMINE THE LAST HIGHEST READING AND APPLY THAT TO THE BUTTON <br>        <br>        if (throttleValue &gt; lastRead) {<br>                 lastRead = throttleValue; // store the current throttle value in last read<br>        }<br>          else if (throttleValue &lt; lastRead) {<br>                 maxRead = lastRead;  // store the max value in last read<br>          }<br>          <br>    <br>          </p>
<p> </p>
<p>    joySt.xAxis = map(xValue, 450, -450, 0, 255);  // here the axis is inverted<br>    joySt.yAxis = map(yValue, -400, 400, 0, 255);<br>        joySt.throttle = map(throttleValue,0,1023,0,255); // scaling the throttle value<br>        <br>        <br>//     if(DEBUG) {<br>//         Serial.print("X: ");<br>//        Serial.println(xValue);<br>//         Serial.print("Y: ");<br>//        Serial.println(yValue);<br>//                Serial.print("Throttle value");<br>//                Serial.println(throttleValue);<br>//    }</p>
<p>//    joySt.xAxis = random(255);<br>//    joySt.yAxis = random(255);<br>//    joySt.zAxis = random(255);<br>//    joySt.xRotAxis = random(255);<br>//    joySt.yRotAxis = random(255);<br>//    joySt.zRotAxis = random(255);<br>//    joySt.throttle = random(255);<br>//    joySt.rudder = random(255);<br>//<br>//    joySt.throttle++;<br>//<br>//<br>//    joySt.buttons &lt;&lt;= 1;<br>//    if (joySt.buttons == 0)<br>//        joySt.buttons = 1;<br>//<br>//    joySt.hatSw1++;<br>//    joySt.hatSw2--;<br>//<br>//    if (joySt.hatSw1 &gt; 8)<br>//        joySt.hatSw1 = 0;<br>//    if (joySt.hatSw2 &gt; 8)<br>//        joySt.hatSw2 = 8;<br>//<br>//    delay(100);<br>//<br>//    if (joySt.throttle &gt; 127)<br>//        digitalWrite(13, HIGH);<br>//    else<br>//        digitalWrite(13, LOW);</p>
<p><br>    // Call Joystick.move<br>    Joystick.setState(&amp;joySt);</p>
<p>}</p>
<p> </p>
<p>I need to figure out how to make a timer that actually counts well. I think. But, it is thanksgiving today, and I have two sick kids. I will have to return to this tomorrow. For now I will just think about it.</p>
</div></body></html>
